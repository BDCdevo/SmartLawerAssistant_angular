<div class="documents-container">
  <!-- Compact Header -->
  <div class="page-header-compact">
    <h1 class="header-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h1>
    <div class="header-actions">
      <button class="action-btn btn-secondary" (click)="loadDocuments()" [disabled]="loading()">
        <span class="btn-icon" [class.spinning]="loading()">ğŸ”„</span>
        <span>ØªØ­Ø¯ÙŠØ«</span>
      </button>
      <button class="action-btn btn-primary" (click)="openUploadModal()">
        <span class="btn-icon">â•</span>
        <span>Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯</span>
      </button>
    </div>
  </div>

  <!-- Compact Filters -->
  <div class="filters-compact">
    <!-- Search Group -->
    <div class="search-group">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (keyup.enter)="onSearch()"
        placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªÙ†Ø¯..."
      />
      <button class="search-btn" (click)="onSearch()">Ø¨Ø­Ø«</button>
    </div>

    <!-- Category Filter -->
    <div class="filter-group">
      <select
        [(ngModel)]="selectedCategory"
        (change)="onFilterChange()"
      >
        @for (category of categories; track category.value) {
          <option [value]="category.value">{{ category.label }}</option>
        }
      </select>
    </div>

    <!-- Case Filter -->
    <div class="filter-group">
      <select
        [(ngModel)]="selectedCaseId"
        (change)="onFilterChange()"
      >
        <option [ngValue]="null">ÙƒÙ„ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</option>
        @for (case of cases(); track case.id) {
          <option [ngValue]="case.id">
            {{ case.number ? (case.number + '/' + case.year) : ('Ù‚Ø¶ÙŠØ© ' + case.id) }}
          </option>
        }
      </select>
    </div>

    <!-- Client Filter -->
    <div class="filter-group">
      <select
        [(ngModel)]="selectedClientId"
        (change)="onFilterChange()"
      >
        <option [ngValue]="null">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
        @for (client of clients(); track client.id) {
          <option [ngValue]="client.id">{{ client.fullName }}</option>
        }
      </select>
    </div>

    <!-- Clear Filters -->
    <button
      class="clear-filters-btn"
      (click)="searchQuery.set(''); selectedCategory.set(''); selectedCaseId.set(null); selectedClientId.set(null); onFilterChange()"
    >
      ğŸ—‘ï¸ Ù…Ø³Ø­
    </button>
  </div>

  <!-- Count Badge -->
  <div class="count-badge" *ngIf="!loading()">
    <span class="badge-icon">ğŸ“Š</span>
    <span>Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª: <span class="badge-number">{{ totalItems() }}</span></span>
  </div>

  <!-- Loading State -->
  <div class="loading-overlay" *ngIf="loading()">
    <div class="spinner"></div>
    <p class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª...</p>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading() && documents().length === 0">
    <div class="empty-icon">ğŸ“­</div>
    <h3 class="empty-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª</h3>
    <p class="empty-description">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø³ØªÙ†Ø¯Ø§Øª. Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø¯Ø¡.</p>
    <button class="action-btn btn-primary" (click)="openUploadModal()">
      <span>â•</span>
      <span>Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯</span>
    </button>
  </div>

  <!-- Documents Table -->
  <div class="table-container" *ngIf="!loading() && documents().length > 0">
    <table class="data-table">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</th>
          <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®Ø²Ù†</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        @for (document of documents(); track document.id) {
          <tr [class.deleted-row]="document.deletedAt">
            <td>{{ document.caseId || '-' }}</td>
            <td class="filename-cell">{{ getOriginalFileName(document) }}</td>
            <td>{{ getStoredFileName(document) }}</td>
            <td class="actions-cell">
              <button
                class="action-btn btn-download"
                (click)="downloadDocument(document)"
                title="ØªØ­Ù…ÙŠÙ„">
                â¬‡ï¸
              </button>
              <button
                class="action-btn btn-view"
                (click)="openAnalysisModal(document)"
                title="ØªØ­Ù„ÙŠÙ„">
                ğŸ”
              </button>
              @if (!document.deletedAt) {
                <button
                  class="action-btn btn-delete"
                  (click)="deleteDocument(document)"
                  title="Ø­Ø°Ù">
                  ğŸ—‘ï¸
                </button>
              } @else {
                <button
                  class="action-btn btn-restore"
                  (click)="restoreDocument(document)"
                  title="Ø§Ø³ØªØ±Ø¬Ø§Ø¹">
                  â†©ï¸
                </button>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="!loading() && documents().length > 0 && getTotalPages() > 1">
    <div class="pagination-info">
      Ø¹Ø±Ø¶ <strong>{{ (currentPage() - 1) * pageSize() + 1 }}</strong> -
      <strong>{{ Math.min(currentPage() * pageSize(), totalItems()) }}</strong>
      Ù…Ù† <strong>{{ totalItems() }}</strong> Ù†ØªÙŠØ¬Ø©
    </div>
    <div class="pagination-controls">
      <button
        class="page-btn prev-btn"
        (click)="onPageChange(currentPage() - 1)"
        [disabled]="currentPage() === 1">
        Â«
      </button>

      @for (page of getPageNumbers(); track page) {
        @if (page === -1) {
          <span class="page-dots">...</span>
        } @else {
          <button
            class="page-btn"
            [class.active]="page === currentPage()"
            (click)="onPageChange(page)">
            {{ page }}
          </button>
        }
      }

      <button
        class="page-btn next-btn"
        (click)="onPageChange(currentPage() + 1)"
        [disabled]="currentPage() === getTotalPages()">
        Â»
      </button>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal-overlay" *ngIf="showUploadModal()" (click)="closeUploadModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <span class="modal-icon">â¬†ï¸</span>
        <span>Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯</span>
      </h2>
      <button class="modal-close" (click)="closeUploadModal()">âœ–</button>
    </div>

    <div class="modal-body">
      <div class="form-grid">
        <!-- Case Select -->
        <div class="form-group">
          <label class="form-label">
            Ø§Ù„Ù‚Ø¶ÙŠØ© <span class="required">*</span>
          </label>
          <select [(ngModel)]="uploadCaseId" class="form-select">
            <option [ngValue]="null">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø¶ÙŠØ©</option>
            @for (case of cases(); track case.id) {
              <option [ngValue]="case.id">
                {{ case.number ? (case.number + '/' + case.year) : ('Ù‚Ø¶ÙŠØ© Ø±Ù‚Ù… ' + case.id) }}
              </option>
            }
          </select>
        </div>

        <!-- Title Input -->
        <div class="form-group">
          <label class="form-label">
            Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯ <span class="required">*</span>
          </label>
          <input
            type="text"
            [(ngModel)]="uploadTitle"
            placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯"
            class="form-input"
          />
        </div>

        <!-- Category Select -->
        <div class="form-group">
          <label class="form-label">
            Ø§Ù„ÙØ¦Ø© <span class="required">*</span>
          </label>
          <select [(ngModel)]="uploadCategory" class="form-select">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
            @for (category of categories; track category.value) {
              @if (category.value) {
                <option [value]="category.value">{{ category.label }}</option>
              }
            }
          </select>
        </div>

        <!-- File Input -->
        <div class="form-group form-group-full">
          <label class="form-label">
            Ø§Ø®ØªØ± Ù…Ù„Ù <span class="required">*</span>
          </label>
          <div class="file-input-wrapper">
            <input
              type="file"
              id="fileInput"
              (change)="onFileSelected($event)"
              class="file-input"
            />
            <label for="fileInput" class="file-input-label">
              <span class="file-icon">ğŸ“</span>
              <span>{{ selectedFile() ? selectedFile()!.name : 'Ø§Ø®ØªØ± Ù…Ù„Ù Ù„Ù„Ø±ÙØ¹' }}</span>
            </label>
          </div>
          @if (selectedFile()) {
            <p class="file-info">
              Ø§Ù„Ø­Ø¬Ù…: {{ formatFileSize(selectedFile()!.size) }}
            </p>
          }
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeUploadModal()" [disabled]="uploading()">
        Ø¥Ù„ØºØ§Ø¡
      </button>
      <button
        class="btn-primary"
        (click)="uploadDocument()"
        [disabled]="uploading() || !selectedFile()">
        @if (uploading()) {
          <span class="spinner-small"></span>
          <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</span>
        } @else {
          <span>â¬†ï¸</span>
          <span>Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</span>
        }
      </button>
    </div>
  </div>
</div>

<!-- Analysis Modal -->
<div class="modal-overlay" *ngIf="showAnalysisModal()" (click)="closeAnalysisModal()">
  <div class="modal-content modal-analysis" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <span class="modal-icon">ğŸ¤–</span>
        <span>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span>
      </h2>
      <button class="modal-close" (click)="closeAnalysisModal()">âœ–</button>
    </div>

    <div class="modal-body">
      @if (selectedDocumentForAnalysis()) {
        <div class="analysis-document-info">
          <div class="analysis-doc-icon">{{ getFileIcon(selectedDocumentForAnalysis()!.fileName) }}</div>
          <div class="analysis-doc-details">
            <h3>{{ selectedDocumentForAnalysis()!.title }}</h3>
            <p>{{ selectedDocumentForAnalysis()!.fileName }}</p>
          </div>
        </div>
      }

      @if (analyzingDocument()) {
        <div class="analysis-loading">
          <div class="spinner"></div>
          <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯...</p>
        </div>
      } @else if (documentAnalysis()) {
        <div class="analysis-content">
          <!-- Analysis Metadata -->
          <div class="analysis-metadata">
            <div class="metadata-item">
              <span class="metadata-label">Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„:</span>
              <span class="metadata-value">{{ documentAnalysis().analysisType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
              <span class="metadata-value">{{ documentAnalysis().model || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Ø§Ù„ÙˆØ¶Ø¹:</span>
              <span class="metadata-value">{{ documentAnalysis().mode || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù„ÙŠÙ„:</span>
              <span class="metadata-value">{{ formatAnalysisDate(documentAnalysis().analyzedAtUtc) }}</span>
            </div>
          </div>

          <!-- Summary Section -->
          @if (documentAnalysis().summary) {
            <div class="analysis-section">
              <h4 class="analysis-section-title">ğŸ“ Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h4>
              <div class="analysis-text">
                {{ documentAnalysis().summary }}
              </div>
            </div>
          }

          <!-- Content Markdown Section -->
          @if (documentAnalysis().contentMarkdown) {
            <div class="analysis-section">
              <h4 class="analysis-section-title">ğŸ“„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„</h4>
              <div class="analysis-markdown" [innerHTML]="documentAnalysis().contentMarkdown"></div>
            </div>
          }

          <!-- Objections Section -->
          @if (getObjections().length > 0) {
            <div class="analysis-section">
              <h4 class="analysis-section-title">âš–ï¸ Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯</h4>
              <div class="objections-list">
                @for (objection of getObjections(); track $index) {
                  <div class="objection-item">
                    <div class="objection-header">
                      <span class="objection-number">#{{ $index + 1 }}</span>
                      <h5 class="objection-title">{{ objection.objection || 'Ø§Ø¹ØªØ±Ø§Ø¶' }}</h5>
                    </div>
                    @if (objection.reply) {
                      <div class="objection-reply">
                        <strong>Ø§Ù„Ø±Ø¯:</strong> {{ objection.reply }}
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="analysis-empty">
          <div class="empty-icon">ğŸ¤–</div>
          <p>Ù„Ù… ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø¹Ø¯</p>
          <button
            class="btn-primary"
            (click)="analyzeDocument(selectedDocumentForAnalysis()!)"
            [disabled]="analyzingDocument()">
            <span>ğŸ”</span>
            <span>Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</span>
          </button>
        </div>
      }
    </div>

    <div class="modal-footer" *ngIf="documentAnalysis() && !analyzingDocument()">
      <button
        class="btn-secondary"
        (click)="reanalyzeDocument(selectedDocumentForAnalysis()!)">
        <span>ğŸ”„</span>
        <span>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</span>
      </button>
      <button class="btn-primary" (click)="closeAnalysisModal()">
        Ø¥ØºÙ„Ø§Ù‚
      </button>
    </div>
  </div>
</div>
