<div class="ai-case-analysis-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="icon">๐ค</span>
        ุชุญููู ุงููุถุงูุง ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
      </h1>
      <p class="page-description">
        ุงุณุชุฎุฏู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุญููู ุงููุถุงูุง ูุงููุณุชูุฏุงุช ูุงูุญุตูู ุนูู ุฑุคู ูุงููููุฉ ูุชุนููุฉ
      </p>
    </div>

    <!-- AI Model Selector -->
    @if (availableModels().length > 0) {
      <div class="model-selector">
        <label for="modelSelect">ุงููููุฐุฌ ุงููุณุชุฎุฏู:</label>
        <ng-select
          [items]="availableModels()"
          bindLabel="name"
          bindValue="id"
          [ngModel]="currentModel()"
          (ngModelChange)="changeModel($event)"
          placeholder="ุงุฎุชุฑ ุงููููุฐุฌ"
          [searchable]="true"
          [clearable]="false"
          class="model-select ng-select-custom"
        >
        </ng-select>
      </div>
    }
  </div>

  <!-- Analysis Type Selector -->
  <div class="analysis-type-selector">
    <button
      class="type-btn"
      [class.active]="analysisMode() === 'case-document'"
      (click)="setAnalysisMode('case-document')"
    >
      <span class="btn-icon">โ๏ธ</span>
      <span class="btn-text">ุชุญููู ูุถูุฉ/ูุณุชูุฏ</span>
    </button>

    <button
      class="type-btn"
      [class.active]="analysisMode() === 'file'"
      (click)="setAnalysisMode('file')"
    >
      <span class="btn-icon">๐</span>
      <span class="btn-text">ุฑูุน ููู</span>
    </button>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Input Panel -->
    <div class="input-panel">
      <div class="panel-card">
        <h2 class="panel-title">ุฅุฏุฎุงู ุงูุจูุงูุงุช</h2>

        <!-- Case/Document Analysis Form -->
        @if (analysisMode() === 'case-document') {
          <form [formGroup]="analysisForm" (ngSubmit)="analyzeCaseDocument()" class="analysis-form">
            <div class="form-row">
              <div class="form-group">
                <label for="caseId" class="form-label">
                  <span class="label-icon">โ๏ธ</span>
                  ุงููุถูุฉ <span class="required">*</span>
                </label>
                <ng-select
                  [items]="casesList()"
                  bindLabel="number"
                  bindValue="id"
                  formControlName="caseId"
                  placeholder="ุงุจุญุซ ูุงุฎุชุฑ ุงููุถูุฉ"
                  [searchable]="true"
                  [clearable]="true"
                  notFoundText="ูุง ุชูุฌุฏ ูุถุงูุง"
                  class="ng-select-custom"
                >
                  <ng-template ng-label-tmp let-item="item">
                    {{ item.number ? (item.number + '/' + item.year) : ('ูุถูุฉ ุฑูู ' + item.id) }}
                  </ng-template>
                  <ng-template ng-option-tmp let-item="item" let-index="index">
                    <div class="option-content">
                      <strong>{{ item.number ? (item.number + '/' + item.year) : ('ูุถูุฉ ุฑูู ' + item.id) }}</strong>
                      @if (item.clientName || item.specialty) {
                        <span class="option-subtitle">{{ item.clientName || item.specialty }}</span>
                      }
                    </div>
                  </ng-template>
                </ng-select>
                @if (analysisForm.get('caseId')?.invalid && analysisForm.get('caseId')?.touched) {
                  <span class="error-message">ูุฑุฌู ุงุฎุชูุงุฑ ูุถูุฉ</span>
                }
              </div>

              <div class="form-group">
                <label for="documentId" class="form-label">
                  <span class="label-icon">๐</span>
                  ุงููุณุชูุฏ <span class="required">*</span>
                </label>
                <ng-select
                  [items]="documentsList()"
                  bindLabel="originalFileName"
                  bindValue="id"
                  formControlName="documentId"
                  placeholder="ุงุจุญุซ ูุงุฎุชุฑ ุงููุณุชูุฏ"
                  [searchable]="true"
                  [clearable]="true"
                  [disabled]="!analysisForm.get('caseId')?.value"
                  notFoundText="ูุง ุชูุฌุฏ ูุณุชูุฏุงุช"
                  class="ng-select-custom"
                >
                  <ng-template ng-label-tmp let-item="item">
                    {{ item.id }} - {{ item.storedFileName || item.originalFileName || item.title || 'ูุณุชูุฏ' }}
                  </ng-template>
                  <ng-template ng-option-tmp let-item="item" let-index="index">
                    <div class="option-content">
                      <strong>#{{ item.id }}</strong>
                      <span class="option-subtitle">{{ item.storedFileName || item.originalFileName || item.title || 'ูุณุชูุฏ' }}</span>
                    </div>
                  </ng-template>
                </ng-select>
                @if (documentsList().length === 0 && analysisForm.get('caseId')?.value) {
                  <span class="info-hint">ูุง ุชูุฌุฏ ูุณุชูุฏุงุช ููุฐู ุงููุถูุฉ</span>
                }
                @if (analysisForm.get('documentId')?.invalid && analysisForm.get('documentId')?.touched) {
                  <span class="error-message">ูุฑุฌู ุงุฎุชูุงุฑ ูุณุชูุฏ ูู ุงููุถูุฉ</span>
                }
              </div>
            </div>

            <div class="form-actions">
              <button
                type="submit"
                class="submit-btn primary"
                [disabled]="analysisForm.invalid"
              >
                <span class="btn-icon">๐</span>
                <span>ุชุญููู ุงููุถูุฉ</span>
              </button>
            </div>
          </form>
        }

        <!-- File Upload Form -->
        @if (analysisMode() === 'file') {
          <div class="analysis-form">
            <div class="form-group">
              <label class="form-label">
                <span class="label-icon">๐</span>
                ุฑูุน ููู ููุชุญููู
              </label>

              <div class="file-upload-area">
                @if (!selectedFile()) {
                  <label for="fileInput" class="file-upload-label">
                    <div class="upload-icon">๐</div>
                    <div class="upload-text">
                      <strong>ุงุถุบุท ูุงุฎุชูุงุฑ ููู</strong>
                      <span>ุฃู ุงุณุญุจ ูุฃููุช ุงูููู ููุง</span>
                    </div>
                    <div class="upload-hint">
                      ุงูุฃููุงุน ุงููุฏุนููุฉ: PDF, Word, Text, Images (ุญุฏ ุฃูุตู 10 ููุฌุงุจุงูุช)
                    </div>
                  </label>
                  <input
                    type="file"
                    id="fileInput"
                    (change)="onFileSelected($event)"
                    class="file-input"
                    accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"
                  />
                } @else {
                  <div class="selected-file">
                    <div class="file-icon">๐</div>
                    <div class="file-info">
                      <div class="file-name">{{ selectedFile()!.name }}</div>
                      <div class="file-size">{{ (selectedFile()!.size / 1024).toFixed(2) }} KB</div>
                    </div>
                    <button type="button" class="remove-file-btn" (click)="removeSelectedFile()">
                      โ
                    </button>
                  </div>
                }
              </div>
            </div>

            <button
              type="button"
              class="submit-btn"
              [disabled]="!selectedFile()"
              (click)="analyzeFile()"
            >
              <span class="btn-icon">๐</span>
              ุชุญููู ุงูููู
            </button>
          </div>
        }
      </div>
    </div>

    <!-- Results Panel -->
    <div class="results-panel">
      @if (analysisResult()) {
        <div class="panel-card results-card">
          <!-- Action Buttons -->
          <div class="results-actions">
            <h2 class="panel-title">
              <span class="title-icon">โ๏ธ</span>
              ูุชูุฌุฉ ุงูุชุญููู ุงููุงูููู
            </h2>
            <div class="action-buttons">
              <button class="action-btn download-btn" (click)="downloadAnalysisReport()" title="ุชูุฒูู ุงูุชูุฑูุฑ">
                <i class="bi bi-download"></i>
                <span>ุชูุฒูู</span>
              </button>
              <button class="action-btn print-btn" (click)="printAnalysisReport()" title="ุทุจุงุนุฉ ุงูุชูุฑูุฑ">
                <i class="bi bi-printer"></i>
                <span>ุทุจุงุนุฉ</span>
              </button>
              <button class="action-btn clear-btn" (click)="clearAnalysis()" title="ูุณุญ ุงููุชุงุฆุฌ">
                <i class="bi bi-trash"></i>
                <span>ูุณุญ</span>
              </button>
            </div>
          </div>

          <!-- Analysis Metadata -->
          <div class="analysis-metadata">
            <div class="metadata-item">
              <i class="bi bi-cpu"></i>
              <span class="label">ุงููููุฐุฌ:</span>
              <span class="value">{{ analysisResult()!.modelUsed }}</span>
            </div>
            <div class="metadata-item">
              <i class="bi bi-clock-history"></i>
              <span class="label">ุงูุชุงุฑูุฎ:</span>
              <span class="value">{{ analysisResult()!.timestamp | date:'dd/MM/yyyy - HH:mm' }}</span>
            </div>
          </div>

          <!-- Full Content with Sections -->
          <div class="analysis-content">
            @if (analysisResult()!.pleaFull || analysisResult()!.rawResponse) {
              <div class="content-viewer" [innerHTML]="formatAnalysisContent(analysisResult()!.pleaFull || analysisResult()!.rawResponse!)"></div>
            }

          </div>
        </div>
      } @else {
        <div class="empty-state">
          <div class="empty-icon">๐ค</div>
          <h3 class="empty-title">ูู ูุชู ุฅุฌุฑุงุก ุชุญููู ุจุนุฏ</h3>
          <p class="empty-text">
            ุงุฎุชุฑ ููุน ุงูุชุญููู ูุฃุฏุฎู ุงูุจูุงูุงุช ุงููุทููุจุฉ ููุญุตูู ุนูู ุชุญููู ุดุงูู ูููุถูุฉ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
          </p>
        </div>
      }
    </div>
  </div>
</div>
